AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: "AgendaF\xE1cil SaaS - Vers\xE3o Simples Funcional"
Parameters:
  Environment:
    Type: String
    Default: dev
Resources:
  AuthFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: AuthFunction
      Handler: index.handler
      Runtime: nodejs18.x
      Environment:
        Variables:
          MAIN_TABLE:
            Ref: MainTable
          COGNITO_USER_POOL_ID:
            Ref: UserPool
          ENVIRONMENT:
            Ref: Environment
          S3_BUCKET:
            Ref: FilesBucket
          COGNITO_CLIENT_ID: temp-client-id
      Events:
        AuthApi:
          Type: Api
          Properties:
            Path: /auth/{proxy+}
            Method: ANY
    Metadata:
      SamResourceId: AuthFunction
  MainTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName:
        Fn::Sub: ${AWS::StackName}-main
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
      - AttributeName: PK
        AttributeType: S
      - AttributeName: SK
        AttributeType: S
      KeySchema:
      - AttributeName: PK
        KeyType: HASH
      - AttributeName: SK
        KeyType: RANGE
  FilesBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName:
        Fn::Sub: ${AWS::StackName}-files-${AWS::AccountId}
  UserPool:
    Type: AWS::Cognito::UserPool
    Properties:
      UserPoolName:
        Fn::Sub: ${AWS::StackName}-users
      AutoVerifiedAttributes:
      - email
      Policies:
        PasswordPolicy:
          MinimumLength: 8
          RequireUppercase: true
          RequireLowercase: true
          RequireNumbers: true
          RequireSymbols: true
Outputs:
  ApiGatewayUrl:
    Description: API Gateway URL
    Value:
      Fn::Sub: https://${ServerlessRestApi}.execute-api.${AWS::Region}.amazonaws.com/Prod
  UserPoolId:
    Description: Cognito User Pool ID
    Value:
      Ref: UserPool
  MainTableName:
    Description: Main DynamoDB Table Name
    Value:
      Ref: MainTable
  FilesBucketName:
    Description: S3 Files Bucket Name
    Value:
      Ref: FilesBucket
