version: 1
backend:
  phases:
    build:
      commands:
        - amplifyPush --simple
frontend:
  phases:
    preBuild:
      commands:
        - npm install
        - npm install -g @aws-amplify/cli
        - flutter pub get
    build:
      commands:
        - echo "Building for tenant: $TENANT_ID"
        - flutter build web --release --dart-define=ENVIRONMENT=$ENV_NAME --dart-define=TENANT_ID=$TENANT_ID
  artifacts:
    baseDirectory: build/web
    files:
      - '**/*'
  cache:
    paths:
      - node_modules/**/*
      - .pub-cache/**/*

customHeaders:
  - pattern: '**/*'
    headers:
      - key: 'Strict-Transport-Security'
        value: 'max-age=31536000; includeSubDomains'
      - key: 'X-Frame-Options'
        value: 'SAMEORIGIN'
      - key: 'X-XSS-Protection'
        value: '1; mode=block'
      - key: 'X-Content-Type-Options'
        value: 'nosniff'
      - key: 'Content-Security-Policy'
        value: "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' data:; connect-src 'self' https://*.amazonaws.com https://*.amplifyapp.com"

environmentVariables:
  - name: ENV_NAME
    value: prod
  - name: TENANT_ID
    value: default

# Configuração para multi-tenant
environments:
  main:
    environmentVariables:
      - name: ENV_NAME
        value: prod
      - name: TENANT_ID
        value: default
  tenant1:
    environmentVariables:
      - name: ENV_NAME
        value: prod
      - name: TENANT_ID
        value: tenant1
  tenant2:
    environmentVariables:
      - name: ENV_NAME
        value: prod
      - name: TENANT_ID
        value: tenant2
  dev:
    environmentVariables:
      - name: ENV_NAME
        value: dev
      - name: TENANT_ID
        value: dev